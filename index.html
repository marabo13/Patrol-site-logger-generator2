<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DCoJ Patrol Logger</title>
<style>
  :root{
    --bg:#0b0214;
    --panel:rgba(255,255,255,.06);
    --border:rgba(255,255,255,.15);
    --text:#f7f2ff;
    --muted:#cdb7ff;
    --good:#2ecc71;
    --bad:#e74c3c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
  }
  .card{
    width:100%;
    max-width:460px;
    padding:18px;
    border-radius:16px;
    border:1px solid var(--border);
    background:var(--panel);
  }
  h1{margin:0 0 6px;font-size:20px}
  .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
  input, select{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#0b0114;
    color:#fff;
    outline:none;
  }
  .btn{
    width:100%;
    padding:14px;
    border-radius:12px;
    border:none;
    cursor:pointer;
    font-weight:900;
    font-size:14px;
    margin-top:12px;
  }
  .start{background:linear-gradient(135deg,var(--good),#1e8f4f);color:#071a10}
  .end{background:linear-gradient(135deg,var(--bad),#b53024);color:#1a0000}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  #status{margin-top:12px;color:var(--muted);font-size:13px;min-height:18px}

  /* Modal */
  .modalBack{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    background:rgba(0,0,0,.65);
  }
  .modal{
    width:100%;
    max-width:460px;
    padding:16px;
    border-radius:16px;
    border:1px solid var(--border);
    background:#11031f;
  }
  .modalHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }
  .x{
    width:34px;height:34px;
    border-radius:10px;
    border:1px solid var(--border);
    background:rgba(255,255,255,.08);
    color:#fff;
    font-weight:900;
    cursor:pointer;
  }
  .rowBtns{
    display:flex;
    gap:10px;
    margin-top:12px;
  }
  .ghost{
    background:rgba(255,255,255,.10);
    color:#fff;
    border:1px solid var(--border);
  }
</style>
</head>

<body>
  <div class="card">
    <h1>DCoJ Patrol Logger</h1>
    <div class="sub">GitHub Pages version. Select rank. Arbiter requires Quaestor supervision.</div>

    <label for="username">Username</label>
    <input id="username" placeholder="Your username" />

    <label for="rank">DCoJ Enforcement Rank</label>
    <select id="rank">
      <option value="">-- Select rank --</option>
      <option>Arbiter</option>
      <option>Quaestor</option>
      <option>Praetor</option>
      <option>Sanctor</option>
      <option>Ast. Chief Arbiter</option>
      <option>Chief Arbiter</option>
    </select>

    <button class="btn start" id="startBtn">üü¢ START PATROL</button>
    <button class="btn end" id="endBtn" disabled>üî¥ END PATROL</button>

    <div id="status"></div>
  </div>

  <!-- Arbiter mentor modal -->
  <div class="modalBack" id="mentorModalBack">
    <div class="modal">
      <div class="modalHead">
        <b>Arbiter Supervision Required</b>
        <button class="x" id="closeMentor">‚úï</button>
      </div>

      <div class="sub" style="margin:0 0 10px;">
        Arbiters can only host patrols under a Quaestor mentor.<br>
        Enter the mentor‚Äôs username below.
      </div>

      <label for="mentorUser">Supervised by: Quaestor</label>
      <input id="mentorUser" placeholder="Mentor username" />

      <div class="rowBtns">
        <button class="btn ghost" id="cancelMentor" style="margin-top:0;">Cancel</button>
        <button class="btn start" id="confirmMentor" style="margin-top:0;">Confirm & Start</button>
      </div>

      <div id="mentorStatus" style="margin-top:10px;color:var(--muted);font-size:13px;min-height:18px;"></div>
    </div>
  </div>

<script>
  // IMPORTANT: Use a NEW webhook URL (regenerate it in Discord first)
  const WEBHOOK_URL = "PASTE_NEW_WEBHOOK_URL_HERE";

  const startBtn = document.getElementById("startBtn");
  const endBtn = document.getElementById("endBtn");
  const statusEl = document.getElementById("status");

  const mentorModalBack = document.getElementById("mentorModalBack");
  const mentorUser = document.getElementById("mentorUser");
  const mentorStatus = document.getElementById("mentorStatus");

  const ranksEl = document.getElementById("rank");
  const usernameEl = document.getElementById("username");

  let patrolStartISO = null;
  let savedMentor = "";

  function setStatus(t){ statusEl.textContent = t; }

  function openMentorModal(){
    mentorUser.value = "";
    mentorStatus.textContent = "";
    mentorModalBack.style.display = "flex";
  }
  function closeMentorModal(){
    mentorModalBack.style.display = "none";
  }

  document.getElementById("closeMentor").onclick = closeMentorModal;
  document.getElementById("cancelMentor").onclick = closeMentorModal;

  function ensureWebhookSet(){
    if (!WEBHOOK_URL || WEBHOOK_URL.includes("PASTE_NEW_WEBHOOK_URL_HERE")) {
      throw new Error("Webhook URL not set. Paste your new Discord webhook URL in the code.");
    }
  }

  // GitHub Pages-safe send: no-cors + text/plain to avoid CORS preflight
  async function sendDiscordEmbed(embed){
    ensureWebhookSet();
    await fetch(WEBHOOK_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ embeds: [embed] })
    });
  }

  function buildStartEmbed({ username, rank, mentor, timeISO }){
    const fields = [
      { name: "Officer", value: `**${username}**`, inline: true },
      { name: "Rank", value: `**${rank}**`, inline: true },
    ];
    if (rank === "Arbiter") {
      fields.push({ name: "Supervised by", value: `**Quaestor ${mentor}**`, inline: false });
    }
    fields.push({ name: "Start", value: `\`${timeISO}\``, inline: false });

    return {
      author: { name: "DCoJ Patrol Logger" },
      title: "üü¢ Patrol Started",
      color: 0x2ecc71,
      fields,
      timestamp: timeISO,
      footer: { text: "GitHub Pages webhook logger" }
    };
  }

  function buildEndEmbed({ username, rank, mentor, startISO, endISO }){
    const fields = [
      { name: "Officer", value: `**${username}**`, inline: true },
      { name: "Rank", value: `**${rank}**`, inline: true },
    ];
    if (rank === "Arbiter") {
      fields.push({ name: "Supervised by", value: `**Quaestor ${mentor}**`, inline: false });
    }
    fields.push({ name: "Start", value: `\`${startISO}\``, inline: false });
    fields.push({ name: "End", value: `\`${endISO}\``, inline: false });

    return {
      author: { name: "DCoJ Patrol Logger" },
      title: "üî¥ Patrol Ended",
      color: 0xe74c3c,
      fields,
      timestamp: endISO,
      footer: { text: "GitHub Pages webhook logger" }
    };
  }

  async function startPatrolWithMentor(mentor){
    const username = usernameEl.value.trim();
    const rank = ranksEl.value;
    const startISO = new Date().toISOString();

    patrolStartISO = startISO;
    savedMentor = mentor || "";

    setStatus("Sending START log...");
    await sendDiscordEmbed(buildStartEmbed({ username, rank, mentor: savedMentor, timeISO: startISO }));

    startBtn.disabled = true;
    endBtn.disabled = false;
    setStatus("‚úÖ Start sent to Discord.");
  }

  startBtn.onclick = async () => {
    try{
      const username = usernameEl.value.trim();
      const rank = ranksEl.value;

      if (!username || !rank) {
        setStatus("‚ùå Please enter username and select a rank.");
        return;
      }

      if (rank === "Arbiter") {
        // Require mentor via popup window
        openMentorModal();
        return;
      }

      // Non-arbiter start
      await startPatrolWithMentor("");
    } catch (e) {
      setStatus("‚ùå " + (e.message || "Failed to send."));
    }
  };

  document.getElementById("confirmMentor").onclick = async () => {
    try{
      const mentor = mentorUser.value.trim();
      if (!mentor) {
        mentorStatus.textContent = "‚ùå Mentor username required for Arbiter.";
        return;
      }
      closeMentorModal();
      await startPatrolWithMentor(mentor);
    } catch (e) {
      mentorStatus.textContent = "‚ùå " + (e.message || "Failed to send.");
    }
  };

  endBtn.onclick = async () => {
    try{
      const username = usernameEl.value.trim();
      const rank = ranksEl.value;
      if (!patrolStartISO) {
        setStatus("‚ùå No patrol start found. Start first.");
        return;
      }
      const endISO = new Date().toISOString();

      setStatus("Sending END log...");
      await sendDiscordEmbed(buildEndEmbed({
        username,
        rank,
        mentor: savedMentor,
        startISO: patrolStartISO,
        endISO
      }));

      patrolStartISO = null;
      savedMentor = "";
      startBtn.disabled = false;
      endBtn.disabled = true;
      setStatus("‚úÖ End sent to Discord.");
    } catch (e) {
      setStatus("‚ùå " + (e.message || "Failed to send."));
    }
  };
</script>
</body>
</html>
